#include "test_kms_request.h"

#include "src/kms_message/kms_kmip_response.h"
#include "src/kms_kmip_response_private.h"


/* An example successful response obtained from Hashicorp Vault.
 *
 tag=ResponseMessage (42007b) type=Structure (01) length=288
  tag=ResponseHeader (42007a) type=Structure (01) length=72
   tag=ProtocolVersion (420069) type=Structure (01) length=32
    tag=ProtocolVersionMajor (42006a) type=Integer (02) length=4 value=1
    tag=ProtocolVersionMinor (42006b) type=Integer (02) length=4 value=4
   tag=TimeStamp (420092) type=DateTime (09) length=8 value=(TODO)
   tag=BatchCount (42000d) type=Integer (02) length=4 value=1
  tag=BatchItem (42000f) type=Structure (01) length=96
   tag=Operation (42005c) type=Enumeration (05) length=4 value=3
   tag=UniqueBatchItemID (420093) type=ByteString (08) length=1 value=A
   tag=ResultStatus (42007f) type=Enumeration (05) length=4 value=0
   tag=ResponsePayload (42007c) type=Structure (01) length=40
    tag=UniqueIdentifier (420094) type=TextString (07) length=32 value=7FJYvnV6XkaUCWuY96bCSc6AuhvkPpqI
  tag=BatchItem (42000f) type=Structure (01) length=96 tag=Operation (42005c) type=Enumeration (05) length=4 value=18
   tag=UniqueBatchItemID (420093) type=ByteString (08) length=1 value=(TODO)
   tag=ResultStatus (42007f) type=Enumeration (05) length=4 value=0
   tag=ResponsePayload (42007c) type=Structure (01) length=40
    tag=UniqueIdentifier (420094) type=TextString (07) length=32 value=7FJYvnV6XkaUCWuY96bCSc6AuhvkPpqI
*/

#define SUCCESS_REGISTER_RESPONSE                                      \
   0x42, 0x00, 0x7b, 0x01, 0x00, 0x00, 0x01, 0x20, 0x42, 0x00, 0x7a, 0x01,    \
      0x00, 0x00, 0x00, 0x48, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20, \
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x92, 0x09, \
      0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x61, 0x55, 0xc9, 0x72, \
      0x42, 0x00, 0x0d, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x60, \
      0x42, 0x00, 0x5c, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x03, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x93, 0x08, 0x00, 0x00, 0x00, 0x01, \
      0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7f, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x7c, 0x01, 0x00, 0x00, 0x00, 0x28, 0x42, 0x00, 0x94, 0x07, \
      0x00, 0x00, 0x00, 0x20, 0x37, 0x46, 0x4a, 0x59, 0x76, 0x6e, 0x56, 0x36, \
      0x58, 0x6b, 0x61, 0x55, 0x43, 0x57, 0x75, 0x59, 0x39, 0x36, 0x62, 0x43, \
      0x53, 0x63, 0x36, 0x41, 0x75, 0x68, 0x76, 0x6b, 0x50, 0x70, 0x71, 0x49, \
      0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x60, 0x42, 0x00, 0x5c, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x93, 0x08, 0x00, 0x00, 0x00, 0x01, 0x42, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7f, 0x05, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7c, 0x01, \
      0x00, 0x00, 0x00, 0x28, 0x42, 0x00, 0x94, 0x07, 0x00, 0x00, 0x00, 0x20, \
      0x37, 0x46, 0x4a, 0x59, 0x76, 0x6e, 0x56, 0x36, 0x58, 0x6b, 0x61, 0x55, \
      0x43, 0x57, 0x75, 0x59, 0x39, 0x36, 0x62, 0x43, 0x53, 0x63, 0x36, 0x41, \
      0x75, 0x68, 0x76, 0x6b, 0x50, 0x70, 0x71, 0x49

#define SUCCESS_REGISTER_RESPONSE_UNIQUE_IDENTIFIER "7FJYvnV6XkaUCWuY96bCSc6AuhvkPpqI"

/* (TODO) PyKMIP only responds with one BatchItem:
tag=ResponseMessage (42007b) type=Structure (01) length=160
 tag=ResponseHeader (42007a) type=Structure (01) length=72
  tag=ProtocolVersion (420069) type=Structure (01) length=32
   tag=ProtocolVersionMajor (42006a) type=Integer (02) length=4 value=1
   tag=ProtocolVersionMinor (42006b) type=Integer (02) length=4 value=4
  tag=TimeStamp (420092) type=DateTime (09) length=8 value=(TODO)
  tag=BatchCount (42000d) type=Integer (02) length=4 value=1
 tag=BatchItem (42000f) type=Structure (01) length=72
  tag=Operation (42005c) type=Enumeration (05) length=4 value=3
  tag=UniqueBatchItemID (420093) type=ByteString (08) length=1 value=(TODO)
  tag=ResultStatus (42007f) type=Enumeration (05) length=4 value=0
  tag=ResponsePayload (42007c) type=Structure (01) length=16
   tag=UniqueIdentifier (420094) type=TextString (07) length=2 value=25

as hex:
42007b01000000a042007a0100000048420069010000002042006a0200000004000000010000000042006b020000000400000004000000004200920900000008000000006155cd0542000d0200000004000000010000000042000f010000004842005c050000000400000003000000004200930800000001410000000000000042007f0500000004000000000000000042007c010000001042009407000000023235000000000000
*/

/* (TODO) PyKMIP error
tag=ResponseMessage (42007b) type=Structure (01) length=200
 tag=ResponseHeader (42007a) type=Structure (01) length=72
  tag=ProtocolVersion (420069) type=Structure (01) length=32
   tag=ProtocolVersionMajor (42006a) type=Integer (02) length=4 value=1
   tag=ProtocolVersionMinor (42006b) type=Integer (02) length=4 value=0
  tag=TimeStamp (420092) type=DateTime (09) length=8 value=(TODO)
  tag=BatchCount (42000d) type=Integer (02) length=4 value=1
 tag=BatchItem (42000f) type=Structure (01) length=112
  tag=ResultStatus (42007f) type=Enumeration (05) length=4 value=1
  tag=ResultReason (42007e) type=Enumeration (05) length=4 value=4
  tag=ResultMessage (42007d) type=TextString (07) length=68 value=Error parsing request message. See server logs for more information.

as hex:
42007b01000000c842007a0100000048420069010000002042006a0200000004000000010000000042006b020000000400000000000000004200920900000008000000006155cd8742000d0200000004000000010000000042000f010000007042007f0500000004000000010000000042007e0500000004000000040000000042007d07000000444572726f722070617273696e672072657175657374206d6573736167652e2053656520736572766572206c6f677320666f72206d6f726520696e666f726d6174696f6e2e00000000
*/

/* (TODO) Hashicorp Vault error on unique identifier not found
2021/10/01 10:43:13.0129: [3400917]:    DEBUG: test_kms_kmip_online: reading response from KMIP server
tag=ResponseMessage (42007b) type=Structure (01) length=168
 tag=ResponseHeader (42007a) type=Structure (01) length=72
  tag=ProtocolVersion (420069) type=Structure (01) length=32
   tag=ProtocolVersionMajor (42006a) type=Integer (02) length=4 value=1
   tag=ProtocolVersionMinor (42006b) type=Integer (02) length=4 value=4
  tag=TimeStamp (420092) type=DateTime (09) length=8 value=(TODO)
  tag=BatchCount (42000d) type=Integer (02) length=4 value=1
 tag=BatchItem (42000f) type=Structure (01) length=80
  tag=Operation (42005c) type=Enumeration (05) length=4 value=10
  tag=ResultStatus (42007f) type=Enumeration (05) length=4 value=1
  tag=ResultReason (42007e) type=Enumeration (05) length=4 value=1
  tag=ResultMessage (42007d) type=TextString (07) length=24 value=ResultReasonItemNotFound

as hex:
42007b01000000a842007a0100000048420069010000002042006a0200000004000000010000000042006b0200000004000000040000000042009209000000080000000061571e8142000d0200000004000000010000000042000f010000005042005c05000000040000000a0000000042007f0500000004000000010000000042007e0500000004000000010000000042007d0700000018526573756c74526561736f6e4974656d4e6f74466f756e64
*/

void
kms_kmip_response_get_unique_identifier_test (void)
{
   uint8_t example_response[] = {SUCCESS_REGISTER_RESPONSE};
   kms_kmip_response_t res;
   char *actual_uid;
   kms_status_t *status;

   res.data = example_response;
   res.len = sizeof (example_response);
   status = kms_status_new ();

   kms_kmip_response_ok (&res, status);
   ASSERT_STATUS_OK (status);

   actual_uid = kms_kmip_response_get_unique_identifier (&res, status);
   ASSERT_STATUS_OK (status);
   ASSERT_CMPSTR (SUCCESS_REGISTER_RESPONSE_UNIQUE_IDENTIFIER, actual_uid);
   free (actual_uid);
   kms_status_destroy (status);
}

/* Successful get response */
#define SUCCESS_GET_RESPONSE                                                  \
   0x42, 0x00, 0x7b, 0x01, 0x00, 0x00, 0x01, 0x58, 0x42, 0x00, 0x7a, 0x01,    \
      0x00, 0x00, 0x00, 0x48, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20, \
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x92, 0x09, \
      0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x61, 0x57, 0x1a, 0x0d, \
      0x42, 0x00, 0x0d, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x01, 0x00, \
      0x42, 0x00, 0x5c, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0a, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7f, 0x05, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7c, 0x01, \
      0x00, 0x00, 0x00, 0xd8, 0x42, 0x00, 0x57, 0x05, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x94, 0x07, \
      0x00, 0x00, 0x00, 0x20, 0x56, 0x65, 0x55, 0x67, 0x71, 0x74, 0x75, 0x54, \
      0x69, 0x34, 0x62, 0x49, 0x38, 0x6d, 0x48, 0x58, 0x48, 0x39, 0x43, 0x65, \
      0x6f, 0x63, 0x62, 0x4d, 0x48, 0x4c, 0x79, 0x72, 0x58, 0x6e, 0x66, 0x46, \
      0x42, 0x00, 0x85, 0x01, 0x00, 0x00, 0x00, 0x98, 0x42, 0x00, 0x86, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x40, 0x01, 0x00, 0x00, 0x00, 0x80, 0x42, 0x00, 0x42, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x45, 0x01, 0x00, 0x00, 0x00, 0x68, 0x42, 0x00, 0x43, 0x08, \
      0x00, 0x00, 0x00, 0x60, 0xff, 0xa8, 0xcc, 0x79, 0xe8, 0xc3, 0x76, 0x3b, \
      0x01, 0x21, 0xfc, 0xd0, 0x6b, 0xb3, 0x48, 0x8c, 0x8b, 0xf4, 0x2c, 0x07, \
      0x74, 0x60, 0x46, 0x40, 0x27, 0x9b, 0x16, 0xb2, 0x64, 0x19, 0x40, 0x30, \
      0xee, 0xb0, 0x83, 0x96, 0x24, 0x1d, 0xef, 0xcc, 0x4d, 0x32, 0xd1, 0x6e, \
      0xa8, 0x31, 0xad, 0x77, 0x71, 0x38, 0xf0, 0x8e, 0x2f, 0x98, 0x56, 0x64, \
      0xc0, 0x04, 0xc2, 0x48, 0x5d, 0x6f, 0x49, 0x91, 0xeb, 0x3d, 0x9e, 0xc3, \
      0x28, 0x02, 0x53, 0x78, 0x36, 0xa9, 0x06, 0x6b, 0x4e, 0x10, 0xae, 0xb5, \
      0x6a, 0x5c, 0xcf, 0x6a, 0xa4, 0x69, 0x01, 0xe6, 0x25, 0xe3, 0x40, 0x0c, \
      0x78, 0x11, 0xd2, 0xec

#define SUCCESS_GET_RESPONSE_SECRETDATA                                       \
   0xff, 0xa8, 0xcc, 0x79, 0xe8, 0xc3, 0x76, 0x3b, 0x01, 0x21, 0xfc, 0xd0,    \
      0x6b, 0xb3, 0x48, 0x8c, 0x8b, 0xf4, 0x2c, 0x07, 0x74, 0x60, 0x46, 0x40, \
      0x27, 0x9b, 0x16, 0xb2, 0x64, 0x19, 0x40, 0x30, 0xee, 0xb0, 0x83, 0x96, \
      0x24, 0x1d, 0xef, 0xcc, 0x4d, 0x32, 0xd1, 0x6e, 0xa8, 0x31, 0xad, 0x77, \
      0x71, 0x38, 0xf0, 0x8e, 0x2f, 0x98, 0x56, 0x64, 0xc0, 0x04, 0xc2, 0x48, \
      0x5d, 0x6f, 0x49, 0x91, 0xeb, 0x3d, 0x9e, 0xc3, 0x28, 0x02, 0x53, 0x78, \
      0x36, 0xa9, 0x06, 0x6b, 0x4e, 0x10, 0xae, 0xb5, 0x6a, 0x5c, 0xcf, 0x6a, \
      0xa4, 0x69, 0x01, 0xe6, 0x25, 0xe3, 0x40, 0x0c, 0x78, 0x11, 0xd2, 0xec

void
kms_kmip_response_get_secretdata_test (void)
{
   uint8_t example_response[] = {SUCCESS_GET_RESPONSE};
   kms_kmip_response_t res;
   uint8_t *actual_secretdata;
   uint32_t actual_secretdata_len;
   kms_status_t *status;
   uint8_t expected_secretdata[] = {SUCCESS_GET_RESPONSE_SECRETDATA};

   res.data = example_response;
   res.len = sizeof (example_response);
   status = kms_status_new ();

   kms_kmip_response_ok (&res, status);
   ASSERT_STATUS_OK (status);

   actual_secretdata =
      kms_kmip_response_get_secretdata (&res, &actual_secretdata_len, status);
   ASSERT_STATUS_OK (status);
   ASSERT_CMPBYTES (expected_secretdata,
                    sizeof (expected_secretdata),
                    actual_secretdata,
                    actual_secretdata_len);
   free (actual_secretdata);
   kms_status_destroy (status);
}

#define ERROR_GET_RESPOSE_NOTFOUND                                            \
   0x42, 0x00, 0x7b, 0x01, 0x00, 0x00, 0x00, 0xa8, 0x42, 0x00, 0x7a, 0x01,    \
      0x00, 0x00, 0x00, 0x48, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20, \
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x92, 0x09, \
      0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x61, 0x57, 0x1e, 0x81, \
      0x42, 0x00, 0x0d, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x50, \
      0x42, 0x00, 0x5c, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0a, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7f, 0x05, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7e, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x7d, 0x07, 0x00, 0x00, 0x00, 0x18, 0x52, 0x65, 0x73, 0x75, \
      0x6c, 0x74, 0x52, 0x65, 0x61, 0x73, 0x6f, 0x6e, 0x49, 0x74, 0x65, 0x6d, \
      0x4e, 0x6f, 0x74, 0x46, 0x6f, 0x75, 0x6e, 0x64

void
kms_kmip_response_get_secretdata_notfound_test (void) {
   uint8_t example_response[] = {ERROR_GET_RESPOSE_NOTFOUND};
   kms_kmip_response_t res;
   kms_status_t *status;
   bool ok;
   uint8_t* secretdata;
   uint32_t secretdata_len;

   res.data = example_response;
   res.len = sizeof (example_response);
   status = kms_status_new ();

   ok = kms_kmip_response_ok (&res, status);
   ASSERT_STATUS_ERROR (status, "ResultReasonItemNotFound");

   kms_status_reset (status);
   secretdata = kms_kmip_response_get_secretdata (&res, &secretdata_len, status);
   ASSERT_STATUS_ERROR (status, "ResultReasonItemNotFound");
   ASSERT (NULL == secretdata);

   kms_status_destroy (status);
}
