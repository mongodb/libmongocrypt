#include "test_kms_request.h"

#include "src/kms_message/kms_kmip_request.h"

void
kms_kmip_request_register_and_activate_secretdata_test (void)
{
#define SECRET_DATA_LENGTH 96
   kms_kmip_request_t *req;
   uint8_t secret_data[SECRET_DATA_LENGTH] = {0};
   kms_status_t *status;

   uint8_t *actual_bytes;
   uint32_t actual_len;

   uint8_t expected_bytes[] = {
      0x42, 0x00, 0x78, 0x01, 0x00, 0x00, 0x01, 0x58, 0x42, 0x00, 0x77, 0x01,
      0x00, 0x00, 0x00, 0x38, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20,
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04,
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0d, 0x02,
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0xe0, 0x42, 0x00, 0x5c, 0x05,
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
      0x42, 0x00, 0x93, 0x08, 0x00, 0x00, 0x00, 0x01, 0x41, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x79, 0x01, 0x00, 0x00, 0x00, 0xb8,
      0x42, 0x00, 0x57, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x07,
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x91, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x42, 0x00, 0x85, 0x01, 0x00, 0x00, 0x00, 0x98, 0x42, 0x00, 0x86, 0x05,
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00,
      0x42, 0x00, 0x40, 0x01, 0x00, 0x00, 0x00, 0x80, 0x42, 0x00, 0x42, 0x05,
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
      0x42, 0x00, 0x45, 0x01, 0x00, 0x00, 0x00, 0x68, 0x42, 0x00, 0x43, 0x08,
      0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x28,
      0x42, 0x00, 0x5c, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x12,
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x93, 0x08, 0x00, 0x00, 0x00, 0x01,
      0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x79, 0x01,
      0x00, 0x00, 0x00, 0x00};
   uint32_t expected_len = sizeof (expected_bytes);

   status = kms_status_new ();
   req = kms_kmip_request_register_and_activate_secretdata_new (
      NULL, secret_data, SECRET_DATA_LENGTH, status);
   ASSERT_STATUS_OK (status);

   actual_bytes = kms_kmip_request_to_bytes (req, &actual_len);
   ASSERT (actual_bytes != NULL);

   ASSERT_CMPBYTES (actual_bytes, actual_len, expected_bytes, expected_len);

   kms_kmip_request_destroy (req);
   kms_status_destroy (status);
#undef SECRET_DATA_LENGTH
}

void
kms_kmip_request_register_and_activate_secretdata_invalid_test (void)
{
#define SECRET_DATA_INVALID_LENGTH 95

   kms_kmip_request_t *req;
   uint8_t secret_data[SECRET_DATA_INVALID_LENGTH] = {0};
   kms_status_t *status;

   status = kms_status_new ();
   req = kms_kmip_request_register_and_activate_secretdata_new (
      NULL, secret_data, SECRET_DATA_INVALID_LENGTH, status);
   ASSERT_STATUS_ERROR (status, "SecretData length");
   ASSERT (req == NULL);

   kms_kmip_request_destroy (req);
   kms_status_destroy (status);
}
