/*
 * Copyright 2021-present MongoDB, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <mongocrypt.h>

#include "mongocrypt-private.h"
#include "test-mongocrypt.h"
#include "test-conveniences.h"

#define SECRET_DATA_LENGTH 96

#define REGISTER_REQUEST                                                      \
   0x42, 0x00, 0x78, 0x01, 0x00, 0x00, 0x01, 0x28, 0x42, 0x00, 0x77, 0x01,    \
      0x00, 0x00, 0x00, 0x38, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20, \
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0d, 0x02, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0xe0, 0x42, 0x00, 0x5c, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x93, 0x08, 0x00, 0x00, 0x00, 0x01, 0x41, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x79, 0x01, 0x00, 0x00, 0x00, 0xb8, \
      0x42, 0x00, 0x57, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x07, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x91, 0x01, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x85, 0x01, 0x00, 0x00, 0x00, 0x98, 0x42, 0x00, 0x86, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x40, 0x01, 0x00, 0x00, 0x00, 0x80, 0x42, 0x00, 0x42, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x45, 0x01, 0x00, 0x00, 0x00, 0x68, 0x42, 0x00, 0x43, 0x08, \
      0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00

#define SUCCESS_REGISTER_RESPONSE                                             \
   0x42, 0x00, 0x7b, 0x01, 0x00, 0x00, 0x01, 0x20, 0x42, 0x00, 0x7a, 0x01,    \
      0x00, 0x00, 0x00, 0x48, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20, \
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x92, 0x09, \
      0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x61, 0x55, 0xc9, 0x72, \
      0x42, 0x00, 0x0d, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x60, \
      0x42, 0x00, 0x5c, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x03, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x93, 0x08, 0x00, 0x00, 0x00, 0x01, \
      0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7f, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x7c, 0x01, 0x00, 0x00, 0x00, 0x28, 0x42, 0x00, 0x94, 0x07, \
      0x00, 0x00, 0x00, 0x20, 0x37, 0x46, 0x4a, 0x59, 0x76, 0x6e, 0x56, 0x36, \
      0x58, 0x6b, 0x61, 0x55, 0x43, 0x57, 0x75, 0x59, 0x39, 0x36, 0x62, 0x43, \
      0x53, 0x63, 0x36, 0x41, 0x75, 0x68, 0x76, 0x6b, 0x50, 0x70, 0x71, 0x49, \
      0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x60, 0x42, 0x00, 0x5c, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x93, 0x08, 0x00, 0x00, 0x00, 0x01, 0x42, 0x00, 0x00, 0x00, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7f, 0x05, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7c, 0x01, \
      0x00, 0x00, 0x00, 0x28, 0x42, 0x00, 0x94, 0x07, 0x00, 0x00, 0x00, 0x20, \
      0x37, 0x46, 0x4a, 0x59, 0x76, 0x6e, 0x56, 0x36, 0x58, 0x6b, 0x61, 0x55, \
      0x43, 0x57, 0x75, 0x59, 0x39, 0x36, 0x62, 0x43, 0x53, 0x63, 0x36, 0x41, \
      0x75, 0x68, 0x76, 0x6b, 0x50, 0x70, 0x71, 0x49

#define SUCCESS_REGISTER_RESPONSE_UNIQUE_IDENTIFIER \
   "7FJYvnV6XkaUCWuY96bCSc6AuhvkPpqI"

static void
kms_ctx_feed_all (mongocrypt_kms_ctx_t *kms_ctx,
                  uint8_t *data,
                  uint32_t datalen)
{
   mongocrypt_status_t *status;
   mongocrypt_binary_t *bytes;
   uint32_t offset = 0;
   bool ok;

   status = mongocrypt_status_new ();
   while (mongocrypt_kms_ctx_bytes_needed (kms_ctx) > 0) {
      uint32_t len = mongocrypt_kms_ctx_bytes_needed (kms_ctx);

      bytes = mongocrypt_binary_new_from_data (data + offset, len);
      ok = mongocrypt_kms_ctx_feed (kms_ctx, bytes);
      ASSERT_OK_STATUS (ok, kms_ctx->status);
      offset += len;
      mongocrypt_binary_destroy (bytes);
   }
   ASSERT_CMPINT (0, ==, mongocrypt_kms_ctx_bytes_needed (kms_ctx));

   mongocrypt_status_destroy (status);
}

static void
_test_mongocrypt_kms_ctx_kmip_register (_mongocrypt_tester_t *tester)
{
   mongocrypt_t *crypt;
   mongocrypt_kms_ctx_t kms_ctx = {0};
   bool ok;
   uint8_t secretdata[SECRET_DATA_LENGTH] = {0};
   uint8_t expect_request[] = {REGISTER_REQUEST};
   uint8_t response[] = {SUCCESS_REGISTER_RESPONSE};
   mongocrypt_binary_t *bytes;
   _mongocrypt_buffer_t result;
   char *expect_result = SUCCESS_REGISTER_RESPONSE_UNIQUE_IDENTIFIER;
   mongocrypt_status_t *status;
   _mongocrypt_endpoint_t *endpoint;

   status = mongocrypt_status_new ();
   endpoint =
      _mongocrypt_endpoint_new ("example.com", -1, NULL /* opts */, status);

   crypt = _mongocrypt_tester_mongocrypt ();
   ok = _mongocrypt_kms_ctx_init_kmip_register (
      &kms_ctx, endpoint, secretdata, SECRET_DATA_LENGTH, &crypt->log);
   ASSERT_OK_STATUS (ok, kms_ctx.status);

   bytes = mongocrypt_binary_new ();
   ok = mongocrypt_kms_ctx_message (&kms_ctx, bytes);
   ASSERT_OK_STATUS (ok, kms_ctx.status);

   ASSERT_CMPBYTES (expect_request,
                    sizeof (expect_request),
                    mongocrypt_binary_data (bytes),
                    mongocrypt_binary_len (bytes));
   kms_ctx_feed_all (&kms_ctx, response, sizeof (response));

   ok = _mongocrypt_kms_ctx_result (&kms_ctx, &result);
   ASSERT_OK_STATUS (ok, kms_ctx.status);
   ASSERT_STREQUAL ((char *) result.data, expect_result);

   mongocrypt_binary_destroy (bytes);
   _mongocrypt_endpoint_destroy (endpoint);
   mongocrypt_status_destroy (status);
   _mongocrypt_kms_ctx_cleanup (&kms_ctx);
   mongocrypt_destroy (crypt);
}

#define ACTIVATE_REQUEST                                                      \
   0x42, 0x00, 0x78, 0x01, 0x00, 0x00, 0x00, 0x88, 0x42, 0x00, 0x77, 0x01,    \
      0x00, 0x00, 0x00, 0x38, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20, \
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0d, 0x02, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x40, 0x42, 0x00, 0x5c, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x79, 0x01, 0x00, 0x00, 0x00, 0x28, 0x42, 0x00, 0x94, 0x07, \
      0x00, 0x00, 0x00, 0x20, 0x37, 0x46, 0x4a, 0x59, 0x76, 0x6e, 0x56, 0x36, \
      0x58, 0x6b, 0x61, 0x55, 0x43, 0x57, 0x75, 0x59, 0x39, 0x36, 0x62, 0x43, \
      0x53, 0x63, 0x36, 0x41, 0x75, 0x68, 0x76, 0x6b, 0x50, 0x70, 0x71, 0x49
#define SUCCESS_ACTIVATE_RESPONSE SUCCESS_REGISTER_RESPONSE
#define SUCCESS_ACTIVATE_RESPONSE_UNIQUE_IDENTIFIER \
   SUCCESS_REGISTER_RESPONSE_UNIQUE_IDENTIFIER

static void
_test_mongocrypt_kms_ctx_kmip_activate (_mongocrypt_tester_t *tester)
{
   mongocrypt_t *crypt;
   mongocrypt_kms_ctx_t kms_ctx = {0};
   bool ok;
   uint8_t expect_request[] = {ACTIVATE_REQUEST};
   uint8_t response[] = {SUCCESS_ACTIVATE_RESPONSE};
   mongocrypt_binary_t *bytes;
   _mongocrypt_buffer_t result;
   char *expect_result = SUCCESS_ACTIVATE_RESPONSE_UNIQUE_IDENTIFIER;
   mongocrypt_status_t *status;
   _mongocrypt_endpoint_t *endpoint;

   status = mongocrypt_status_new ();
   endpoint =
      _mongocrypt_endpoint_new ("example.com", -1, NULL /* opts */, status);

   crypt = _mongocrypt_tester_mongocrypt ();
   ok = _mongocrypt_kms_ctx_init_kmip_activate (
      &kms_ctx,
      endpoint,
      SUCCESS_ACTIVATE_RESPONSE_UNIQUE_IDENTIFIER,
      &crypt->log);
   ASSERT_OK_STATUS (ok, kms_ctx.status);

   bytes = mongocrypt_binary_new ();
   ok = mongocrypt_kms_ctx_message (&kms_ctx, bytes);
   ASSERT_OK_STATUS (ok, kms_ctx.status);

   ASSERT_CMPBYTES (expect_request,
                    sizeof (expect_request),
                    mongocrypt_binary_data (bytes),
                    mongocrypt_binary_len (bytes));
   kms_ctx_feed_all (&kms_ctx, response, sizeof (response));

   ok = _mongocrypt_kms_ctx_result (&kms_ctx, &result);
   ASSERT_OK_STATUS (ok, kms_ctx.status);
   ASSERT_STREQUAL ((char *) result.data, expect_result);

   mongocrypt_binary_destroy (bytes);
   _mongocrypt_endpoint_destroy (endpoint);
   mongocrypt_status_destroy (status);
   _mongocrypt_kms_ctx_cleanup (&kms_ctx);
   mongocrypt_destroy (crypt);
}

#define GET_REQUEST                                                           \
   0x42, 0x00, 0x78, 0x01, 0x00, 0x00, 0x00, 0x88, 0x42, 0x00, 0x77, 0x01,    \
      0x00, 0x00, 0x00, 0x38, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20, \
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0d, 0x02, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x00, 0x40, 0x42, 0x00, 0x5c, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x79, 0x01, 0x00, 0x00, 0x00, 0x28, 0x42, 0x00, 0x94, 0x07, \
      0x00, 0x00, 0x00, 0x20, 0x37, 0x46, 0x4a, 0x59, 0x76, 0x6e, 0x56, 0x36, \
      0x58, 0x6b, 0x61, 0x55, 0x43, 0x57, 0x75, 0x59, 0x39, 0x36, 0x62, 0x43, \
      0x53, 0x63, 0x36, 0x41, 0x75, 0x68, 0x76, 0x6b, 0x50, 0x70, 0x71, 0x49
#define GET_REQUEST_UNIQUE_IDENTIFIER \
   SUCCESS_REGISTER_RESPONSE_UNIQUE_IDENTIFIER
#define SUCCESS_GET_RESPONSE                                                  \
   0x42, 0x00, 0x7b, 0x01, 0x00, 0x00, 0x01, 0x58, 0x42, 0x00, 0x7a, 0x01,    \
      0x00, 0x00, 0x00, 0x48, 0x42, 0x00, 0x69, 0x01, 0x00, 0x00, 0x00, 0x20, \
      0x42, 0x00, 0x6a, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x6b, 0x02, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x92, 0x09, \
      0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x61, 0x57, 0x1a, 0x0d, \
      0x42, 0x00, 0x0d, 0x02, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x0f, 0x01, 0x00, 0x00, 0x01, 0x00, \
      0x42, 0x00, 0x5c, 0x05, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x0a, \
      0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7f, 0x05, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x7c, 0x01, \
      0x00, 0x00, 0x00, 0xd8, 0x42, 0x00, 0x57, 0x05, 0x00, 0x00, 0x00, 0x04, \
      0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x94, 0x07, \
      0x00, 0x00, 0x00, 0x20, 0x56, 0x65, 0x55, 0x67, 0x71, 0x74, 0x75, 0x54, \
      0x69, 0x34, 0x62, 0x49, 0x38, 0x6d, 0x48, 0x58, 0x48, 0x39, 0x43, 0x65, \
      0x6f, 0x63, 0x62, 0x4d, 0x48, 0x4c, 0x79, 0x72, 0x58, 0x6e, 0x66, 0x46, \
      0x42, 0x00, 0x85, 0x01, 0x00, 0x00, 0x00, 0x98, 0x42, 0x00, 0x86, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x40, 0x01, 0x00, 0x00, 0x00, 0x80, 0x42, 0x00, 0x42, 0x05, \
      0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, \
      0x42, 0x00, 0x45, 0x01, 0x00, 0x00, 0x00, 0x68, 0x42, 0x00, 0x43, 0x08, \
      0x00, 0x00, 0x00, 0x60, 0xff, 0xa8, 0xcc, 0x79, 0xe8, 0xc3, 0x76, 0x3b, \
      0x01, 0x21, 0xfc, 0xd0, 0x6b, 0xb3, 0x48, 0x8c, 0x8b, 0xf4, 0x2c, 0x07, \
      0x74, 0x60, 0x46, 0x40, 0x27, 0x9b, 0x16, 0xb2, 0x64, 0x19, 0x40, 0x30, \
      0xee, 0xb0, 0x83, 0x96, 0x24, 0x1d, 0xef, 0xcc, 0x4d, 0x32, 0xd1, 0x6e, \
      0xa8, 0x31, 0xad, 0x77, 0x71, 0x38, 0xf0, 0x8e, 0x2f, 0x98, 0x56, 0x64, \
      0xc0, 0x04, 0xc2, 0x48, 0x5d, 0x6f, 0x49, 0x91, 0xeb, 0x3d, 0x9e, 0xc3, \
      0x28, 0x02, 0x53, 0x78, 0x36, 0xa9, 0x06, 0x6b, 0x4e, 0x10, 0xae, 0xb5, \
      0x6a, 0x5c, 0xcf, 0x6a, 0xa4, 0x69, 0x01, 0xe6, 0x25, 0xe3, 0x40, 0x0c, \
      0x78, 0x11, 0xd2, 0xec
#define SUCCESS_GET_RESPONSE_SECRETDATA                                       \
   0xff, 0xa8, 0xcc, 0x79, 0xe8, 0xc3, 0x76, 0x3b, 0x01, 0x21, 0xfc, 0xd0,    \
      0x6b, 0xb3, 0x48, 0x8c, 0x8b, 0xf4, 0x2c, 0x07, 0x74, 0x60, 0x46, 0x40, \
      0x27, 0x9b, 0x16, 0xb2, 0x64, 0x19, 0x40, 0x30, 0xee, 0xb0, 0x83, 0x96, \
      0x24, 0x1d, 0xef, 0xcc, 0x4d, 0x32, 0xd1, 0x6e, 0xa8, 0x31, 0xad, 0x77, \
      0x71, 0x38, 0xf0, 0x8e, 0x2f, 0x98, 0x56, 0x64, 0xc0, 0x04, 0xc2, 0x48, \
      0x5d, 0x6f, 0x49, 0x91, 0xeb, 0x3d, 0x9e, 0xc3, 0x28, 0x02, 0x53, 0x78, \
      0x36, 0xa9, 0x06, 0x6b, 0x4e, 0x10, 0xae, 0xb5, 0x6a, 0x5c, 0xcf, 0x6a, \
      0xa4, 0x69, 0x01, 0xe6, 0x25, 0xe3, 0x40, 0x0c, 0x78, 0x11, 0xd2, 0xec

static void
_test_mongocrypt_kms_ctx_kmip_get (_mongocrypt_tester_t *tester)
{
   mongocrypt_t *crypt;
   mongocrypt_kms_ctx_t kms_ctx = {0};
   bool ok;
   uint8_t expect_request[] = {GET_REQUEST};
   uint8_t response[] = {SUCCESS_GET_RESPONSE};
   mongocrypt_binary_t *bytes;
   _mongocrypt_buffer_t result;
   uint8_t expect_result[] = {SUCCESS_GET_RESPONSE_SECRETDATA};
   mongocrypt_status_t *status;
   _mongocrypt_endpoint_t *endpoint;

   status = mongocrypt_status_new ();
   endpoint =
      _mongocrypt_endpoint_new ("example.com", -1, NULL /* opts */, status);

   crypt = _mongocrypt_tester_mongocrypt ();
   ok = _mongocrypt_kms_ctx_init_kmip_get (
      &kms_ctx, endpoint, GET_REQUEST_UNIQUE_IDENTIFIER, &crypt->log);
   ASSERT_OK_STATUS (ok, kms_ctx.status);

   bytes = mongocrypt_binary_new ();
   ok = mongocrypt_kms_ctx_message (&kms_ctx, bytes);
   ASSERT_OK_STATUS (ok, kms_ctx.status);

   ASSERT_CMPBYTES (expect_request,
                    sizeof (expect_request),
                    mongocrypt_binary_data (bytes),
                    mongocrypt_binary_len (bytes));
   kms_ctx_feed_all (&kms_ctx, response, sizeof (response));

   ok = _mongocrypt_kms_ctx_result (&kms_ctx, &result);
   ASSERT_OK_STATUS (ok, kms_ctx.status);
   ASSERT_CMPBYTES (
      result.data, result.len, expect_result, sizeof (expect_result));

   mongocrypt_binary_destroy (bytes);
   _mongocrypt_endpoint_destroy (endpoint);
   mongocrypt_status_destroy (status);
   _mongocrypt_kms_ctx_cleanup (&kms_ctx);
   mongocrypt_destroy (crypt);
}

void
_mongocrypt_tester_install_kms_ctx (_mongocrypt_tester_t *tester)
{
   INSTALL_TEST (_test_mongocrypt_kms_ctx_kmip_register);
   INSTALL_TEST (_test_mongocrypt_kms_ctx_kmip_activate);
   INSTALL_TEST (_test_mongocrypt_kms_ctx_kmip_get);
}
